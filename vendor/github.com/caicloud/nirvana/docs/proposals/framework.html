
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Framework Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="kickoff.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Proposals
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="kickoff.html">
            
                <a href="kickoff.html">
            
                    
                    Kickoff
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.2" data-path="framework.html">
            
                <a href="framework.html">
            
                    
                    Framework
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    Topics
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../topics/routes.html">
            
                <a href="../topics/routes.html">
            
                    
                    Routes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../topics/cli.html">
            
                <a href="../topics/cli.html">
            
                    
                    CLI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../topics/error.html">
            
                <a href="../topics/error.html">
            
                    
                    Error
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../topics/validation.html">
            
                <a href="../topics/validation.html">
            
                    
                    Validation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../topics/openapi.html">
            
                <a href="../topics/openapi.html">
            
                    
                    Open API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../topics/metrics.html">
            
                <a href="../topics/metrics.html">
            
                    
                    Metrics
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../topics/tracing.html">
            
                <a href="../topics/tracing.html">
            
                    
                    Tracing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="../topics/testing.html">
            
                <a href="../topics/testing.html">
            
                    
                    Testing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Framework</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong> <em>generated with <a href="https://github.com/thlorenz/doctoc" target="_blank">DocToc</a></em></p>
<ul>
<li><a href="#api-framework">API Framework</a><ul>
<li><a href="#background">Background</a></li>
<li><a href="#design-assumptions">Design Assumptions</a></li>
<li><a href="#proposed-design">Proposed Design</a><ul>
<li><a href="#log">Log</a></li>
<li><a href="#error">Error</a></li>
<li><a href="#tracing">Tracing</a></li>
<li><a href="#router">Router</a></li>
<li><a href="#middleware">Middleware</a></li>
<li><a href="#handler">Handler</a></li>
</ul>
</li>
<li><a href="#architecture-overview">Architecture Overview</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h1 id="api-framework">API Framework</h1>
<ul>
<li>Author: @kdada</li>
<li>Initial issue: <a href="https://github.com/caicloud/nirvana/issues/2" target="_blank">https://github.com/caicloud/nirvana/issues/2</a></li>
</ul>
<h2 id="background">Background</h2>
<p>We need a uniform api framework to standarize our api project.</p>
<h2 id="design-assumptions">Design Assumptions</h2>
<ul>
<li>API projects run in internal environment. They don&apos;t care about connection security.</li>
<li>API projects are modularized and have low coupling with engaged framework.</li>
<li>APIs are not performance sensitive.</li>
<li>APIs are restful.</li>
<li>No html render requirements.</li>
<li>No session requirements.</li>
<li>No streaming uploading requirements.</li>
</ul>
<h2 id="proposed-design">Proposed Design</h2>
<p>The core components of api framework should have a router and a handler specification. Router is responsible
for dispatching requests to handlers. Then handlers validate requests and inject parameters to api methods
defined by users. After the execution of api methods, handlers analyze the returned values and write
corresponding data to responses.</p>
<p>The main components with dependencies:</p>
<ul>
<li>Router<ul>
<li>Log</li>
<li>Error</li>
<li>Middleware</li>
</ul>
</li>
<li>Handler<ul>
<li>Log</li>
<li>Error</li>
<li>Validator</li>
<li>Injector</li>
<li>Context</li>
<li>Tracing</li>
</ul>
</li>
<li>Client<ul>
<li>Log</li>
<li>Error</li>
<li>Tracing</li>
</ul>
</li>
</ul>
<h3 id="log">Log</h3>
<p>A standard logger interface:</p>
<pre><code class="lang-go"><span class="hljs-keyword">type</span> Verboser <span class="hljs-keyword">interface</span> {
    Info(...<span class="hljs-keyword">interface</span>{})
    Infof(...<span class="hljs-keyword">interface</span>{})
    Infoln(...<span class="hljs-keyword">interface</span>{})
}
<span class="hljs-keyword">type</span> Logger <span class="hljs-keyword">interface</span> {
    V(<span class="hljs-keyword">int</span>) Verboser
    Info(...<span class="hljs-keyword">interface</span>{})
    Infof(...<span class="hljs-keyword">interface</span>{})
    Infoln(...<span class="hljs-keyword">interface</span>{})
    Warning(...<span class="hljs-keyword">interface</span>{})
    Warningf(...<span class="hljs-keyword">interface</span>{})
    Warningln(...<span class="hljs-keyword">interface</span>{})
    Error(...<span class="hljs-keyword">interface</span>{})
    Errorf(...<span class="hljs-keyword">interface</span>{})
    Errorln(...<span class="hljs-keyword">interface</span>{})
    Fatal(...<span class="hljs-keyword">interface</span>{})
    Fatalf(...<span class="hljs-keyword">interface</span>{})
    Fatalln(...<span class="hljs-keyword">interface</span>{})
}
</code></pre>
<h3 id="error">Error</h3>
<p>A standard error interface:</p>
<pre><code class="lang-go"><span class="hljs-keyword">type</span> Error <span class="hljs-keyword">interface</span> {
    Code() <span class="hljs-keyword">int</span>
    Message() <span class="hljs-keyword">interface</span>{}
}
</code></pre>
<h3 id="tracing">Tracing</h3>
<p>Tracing system could be <a href="http://zipkin.io/" target="_blank">Zipkin</a> or <a href="https://uber.github.io/jaeger/" target="_blank">Jeager</a>. The two
implement <a href="http://opentracing.io/" target="_blank">opentracing</a>. And we will integrate opentracing via
<a href="https://github.com/opentracing/opentracing-go" target="_blank">opentracing-go</a>.</p>
<h3 id="router">Router</h3>
<p>URL path is a long continuous string. But we can convert it to an array of segments. For example, we have an
instance of url path:</p>
<pre><code>/collections/object/subresources/resource
</code></pre><p>We can split the path by &apos;/&apos;, then we get an array:</p>
<pre><code>[collections, object, subresources, resource]
</code></pre><p>Router is a tree. Like this:</p>
<pre><code>/
|-- collections
|---- (object:*)
|------ subresources
|-------- (resource:*)
|-- others
</code></pre><p>Every node should match one segement. Pass the array to root node of router, it finds the leaf node matched
the last segement. Then the handler of the leaf node handles the request.</p>
<p>In the example, It shows we need support two kinds of router nodes:</p>
<ul>
<li>String node
A string router can match a fixed segment of url path.</li>
<li>Regexp node
A regexp router can match multiple forms of segment.</li>
</ul>
<p>The handler of node should implement:</p>
<pre><code>type Handler interface {
    Handle(context.Context)
}
</code></pre><h3 id="middleware">Middleware</h3>
<p>As saying above, a router node can have one handler. But it can have multiple middlewares, middlewares decides
the execution of router.</p>
<pre><code>type Middleware interface {
    Prerouting(context.Context) bool
    Postrouting(context.Context) bool
}
</code></pre><p>Middleware can cancel the routing process and return immediately.</p>
<p><strong>Alternative Middleware</strong></p>
<pre><code>type RoutingChain interface {
    Continue(context.Context)
}

type Middleware interface {
    Handle(context.Context, RoutingChain) bool
}
</code></pre><h3 id="handler">Handler</h3>
<pre><code class="lang-go"><span class="hljs-keyword">type</span> FromType <span class="hljs-keyword">string</span>

<span class="hljs-keyword">const</span> (
    FromPath   FromType = <span class="hljs-string">&quot;FromPath&quot;</span>
    FromHeader FromType = <span class="hljs-string">&quot;FromHeader&quot;</span>
    FromForm   FromType = <span class="hljs-string">&quot;FromForm&quot;</span>
    FromBody   FromType = <span class="hljs-string">&quot;FromBody&quot;</span>
)

<span class="hljs-keyword">type</span> ResultType <span class="hljs-keyword">string</span>

<span class="hljs-keyword">const</span> (
    DataResult ResultType = <span class="hljs-string">&quot;DataResult&quot;</span>
)

<span class="hljs-keyword">type</span> Parameter <span class="hljs-keyword">struct</span> {
    From     FromType
    Name     <span class="hljs-keyword">string</span>
    Document <span class="hljs-keyword">string</span>
    Type     <span class="hljs-keyword">string</span>
    Required <span class="hljs-keyword">bool</span>
    Default  <span class="hljs-keyword">interface</span>{}
}

<span class="hljs-keyword">type</span> Result <span class="hljs-keyword">struct</span> {
    Type ResultType
}

<span class="hljs-keyword">type</span> Function <span class="hljs-keyword">struct</span> {
    Pointer    <span class="hljs-keyword">interface</span>{}
    Parameters []Parameter
    Results    []Result
    Errors     []Error
}

<span class="hljs-keyword">type</span> ContentType <span class="hljs-keyword">struct</span> {
    Acceptable []<span class="hljs-keyword">string</span>
    Generable  []<span class="hljs-keyword">string</span>
}

<span class="hljs-keyword">type</span> Definition <span class="hljs-keyword">struct</span> {
    HTTPMethod  <span class="hljs-keyword">string</span>
    Summary     <span class="hljs-keyword">string</span>
    Document    <span class="hljs-keyword">string</span>
    ContentType ContentType
    Function    Function
}

<span class="hljs-keyword">type</span> Descriptor <span class="hljs-keyword">struct</span> {
    Path        <span class="hljs-keyword">string</span>
    Middlewares []Middleware
    Definitions []Definition
    Children    []Descriptor
}
</code></pre>
<h2 id="architecture-overview">Architecture Overview</h2>
<p align="center"><img src="https://user-images.githubusercontent.com/13895988/34514829-d9a9b43c-f034-11e7-9dee-5c7940755fab.png" height="350px" width="auto"></p>

<p><code>log</code> and <code>errors</code> are based on other packages, so we don&apos;t explain it in the diagram.</p>
<p><code>nirvana</code> is the root package in the framework. It implements a configurable server structure. All plugins
implement config interface:</p>
<pre><code class="lang-go"><span class="hljs-comment">// ConfigInstaller is used to install config to service builder.</span>
<span class="hljs-keyword">type</span> ConfigInstaller <span class="hljs-keyword">interface</span> {
    <span class="hljs-comment">// Name is the external config name.</span>
    Name() <span class="hljs-keyword">string</span>
    <span class="hljs-comment">// Install installs stuffs before server starting.</span>
    Install(builder service.Builder, config *Config) error
    <span class="hljs-comment">// Uninstall uninstalls stuffs after server terminating.</span>
    Uninstall(builder service.Builder, config *Config) error
}
</code></pre>
<p>The startup flow:</p>
<p align="center"><img src="https://user-images.githubusercontent.com/13895988/34515618-8cbc6df0-f038-11e7-90b5-71dd770815a2.png" height="350px" width="auto"></p>

<p>Definition modifier is special. It only works in service builder and is used to modify definitions. That means
if you install some API definitions into nirvana server, you have a chance to modify all definitions globally.
The most important usage of modifier is to inject <code>context.Context</code> into <code>Definition.Parameters</code> as first
parameter.</p>
<p>The shutdown flow:</p>
<p align="center"><img src="https://user-images.githubusercontent.com/13895988/34515419-a2dc02d6-f037-11e7-95ec-566efcc193f7.png" height="350px" width="auto"></p>

<p>All plugins are independent, so plugins are installed and uninstalled without order. In this stage, plugins
can close file descriptors or close network connections.</p>
<p>The lifecycle of requests:</p>
<p align="center"><img src="https://user-images.githubusercontent.com/13895988/34516016-900f165e-f03a-11e7-9bad-536cc3ac906f.png" height="350px" width="auto"></p>

<p><code>ParameterGenerators</code> are generated from <code>Definition.Parameters</code>. A parameter corresponds to a <code>ParameterGenerator</code>.</p>
<p align="center"><img src="https://user-images.githubusercontent.com/13895988/34516454-7215cda8-f03c-11e7-8fcf-e06147c9d98d.png" height="350px" width="auto"></p>

<p>Every parameter should go through the flow. Operators execute one by one. The original data passes to first
operator, then the result of first operator is as the parameter to pass to the second operator. The last
operator&apos;s result is as the final data to user function. If there are no operators, typed data is as the
final data.</p>
<p>The workflow of <code>DestinationHandlers</code> is like <code>ParameterGenerators</code>. The returned value of user function is
passed to operators. Then the returned value of last operator is as final data to client.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="kickoff.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Kickoff">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Framework","level":"1.2.2","depth":2,"next":{"title":"Topics","level":"1.3","depth":1,"ref":"","articles":[{"title":"Routes","level":"1.3.1","depth":2,"path":"topics/routes.md","ref":"topics/routes.md","articles":[]},{"title":"CLI","level":"1.3.2","depth":2,"path":"topics/cli.md","ref":"topics/cli.md","articles":[]},{"title":"Error","level":"1.3.3","depth":2,"path":"topics/error.md","ref":"topics/error.md","articles":[]},{"title":"Validation","level":"1.3.4","depth":2,"path":"topics/validation.md","ref":"topics/validation.md","articles":[]},{"title":"Open API","level":"1.3.5","depth":2,"path":"topics/openapi.md","ref":"topics/openapi.md","articles":[]},{"title":"Metrics","level":"1.3.6","depth":2,"path":"topics/metrics.md","ref":"topics/metrics.md","articles":[]},{"title":"Tracing","level":"1.3.7","depth":2,"path":"topics/tracing.md","ref":"topics/tracing.md","articles":[]},{"title":"Testing","level":"1.3.8","depth":2,"path":"topics/testing.md","ref":"topics/testing.md","articles":[]}]},"previous":{"title":"Kickoff","level":"1.2.1","depth":2,"path":"proposals/kickoff.md","ref":"proposals/kickoff.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"proposals/framework.md","mtime":"2018-05-02T02:20:52.463Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-05-02T02:57:17.939Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

